{% extends "base.html" %}

{% load i18n humanize static %}

{% block content %}
    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
        <div class="container">
            <h1 class="display-3">Hello, {{ TENANT_NAME|default:"world" }}!</h1>
            <p>This is a boilerplate for starting business / SaaS related webpages. Use it as a starting point to create
                something more
                unique.</p>
            <p>
                <a class="btn btn-primary btn-lg" href="https://github.com/jensneuhaus/einhorn-starter" role="button">Github
                    &raquo;</a>
                <a class="btn btn-primary btn-lg" href="{% url 'api_docs' %}" role="button">Swagger Docs &raquo;</a>
            </p>
        </div>
    </div>

    <div class="jumbotron">
        <div class="container">
            <h2>Websockets</h2>
            <a class="btn btn-primary btn-lg" href="#" onclick="return false;" id="send_notification" role="button">Send number &raquo;</a>
            <ul class="actionlist" id="ws_messages">
                {% for message in ws_messages %}
                    <li>{{ message|escape }}</li>
                {% endfor %}
            </ul>


            <h3>{% trans 'Users online' %} ({{ logged_in_users.count|default:0 }})</h3>
            <ul class="actionlist" id="users_online_list">
                {#            {% for user in logged_in_users %}#}
                {#                <li data-username="{{ user.username|escape }}">#}
                {#                    {{ user.get_full_name|escape }}#}
                {#                </li>#}
                {#            {% endfor %}#}
            </ul>


            {#            <h2 class="display-3">Notifications</h2>#}
            {#            <p>The boilerplate offers notifications. Just press the button and check the notification in other browsers.</p>#}
            {#            <a class="btn btn-primary btn-lg" href="{% url 'api_docs' %}" role="button">Send a notification &raquo;</a>#}
            {##}
            {#          <div class="container" style="margin-top: 30px" id="intro">#}
            {#    <h4>Notification live stream</h4>#}
            {#    <div class="row">#}
            {#      <div class="one-half column">#}
            {#        <p>Here you'll see new notifications as they arrive from the server.</p>#}
            {#      </div>#}
            {#      <div class="one-half column">#}
            {#        <ul class="notification-list">#}
            {#          <li class="notification-before-list">Notifications (<span class="notification-cnt">0</span>):</li>#}
            {#          <li class="notifications-empty"><em>{% trans "No notifications found" %}</em></li>#}
            {#        </ul>#}
            {#        <a href="javascript:void(0)" onclick="nyt_mark_read()" class="button button-secondary">#}
            {#          {% trans "Mark seen and clear" %}#}
            {#        </a>#}
            {#        <a href="javascript:void(0)" onclick="nyt_update()" class="button button-primary">#}
            {#          {% trans "Fetch" %}#}
            {#        </a>#}
            {#      </div>#}
            {#    </div>#}
            {#  </div>#}
            {##}
            {#          <div class="container" style="margin-top: 30px" id="create-notification">#}
            {#            <h4>Create a notification</h4>#}
            {#            <div class="row">#}
            {#              <div class="one-half column">#}
            {#                <p>After filling in the form, everyone subscribed to receive notification instantly for the Test Model object should receive them.</p>#}
            {#                <p>#}
            {#                  <strong>NB!</strong> By design, saving a notification does not trigger displaying one. This way, you can play around with automatic updating and channels.#}
            {#                </p>#}
            {#              </div>#}
            {#              <div class="one-half column">#}
            {##}
            {#                <form method="POST" action="{% url 'create_notification' %}" id="notificationcreateform">#}
            {#                  {% csrf_token %}#}
            {#                  <label for="exampleEmailInput">Notification message</label>#}
            {#                  {{ testmodel_form.name }}#}
            {#                  <button type="submit" class="button-primary">Save</button>#}
            {#                </form>#}
            {##}
            {#              </div>#}
            {#            </div>#}
            {#          </div>#}
            {##}
            {#            <div class="container" style="margin-top: 30px" id="intro">#}
            {#                <h4>List of notifications (static)</h4>#}
            {#                <div class="row">#}
            {#                  <div class="one-half column">#}
            {#                    <p>Please reload this page to have the list updated</p>#}
            {#                  </div>#}
            {#                  <div class="one-half column">#}
            {#                  </div>#}
            {#                </div>#}
            {#                <table>#}
            {#                  <tr>#}
            {#                    <th>Message</th>#}
            {#                    <th>Created</th>#}
            {#                    <th>Seen</th>#}
            {#                    <th>Type</th>#}
            {#                  </tr>#}
            {##}
            {#                  {% for notification in notifications %}#}
            {#                  <tr>#}
            {#                    <td>{{ notification.message }} x{{ notification.occurrences }}</td>#}
            {#                    <td>{{ notification.modified|naturaltime }}</td>#}
            {#                    <td>{{ notification.is_viewed|yesno }}</td>#}
            {#                    <td>{{ notification.subscription.notification_type.key }}</td>#}
            {#                  </tr>#}
            {#                  {% endfor %}#}
            {##}
            {#                </table>#}
            {#          </div>#}


        </div>
    </div>

{% endblock %}


{% block script %}

    <script src="{% static 'js/jquery-1.11.1.js' %}"></script>

    <script>

        $(document).ready(function () {

            // Note that the path doesn't matter for routing; any WebSocket
            // connection gets bumped over to WebSocket consumers
            var socket = new WebSocket("ws://" + window.location.host + "/chat/");

            $("#send_notification").click(function () {
                var number = 1 + Math.floor(Math.random() * 10000);
                socket.send(number);
            });


            socket.onmessage = function (e) {
                $('#ws_messages').append("<li>" + e.data + "</li>");
            }

        });


        {#        $(document).ready(function () {#}
        {##}
        {#            var socket = new WebSocket('ws://' + window.location.host + '/users/');#}
        {##}
        {#            socket.onopen = function open() {#}
        {#                console.log('Admin WebSockets connection created.');#}
        {#            };#}
        {##}
        {#            socket.onmessage = function message(event) {#}
        {##}
        {#                var data = JSON.parse(event.data);#}
        {##}
        {#                console.log("Received new data: " + event.data);#}
        {##}
        {#                // NOTE: We escape JavaScript to prevent XSS attacks.#}
        {#                var username = encodeURI(data['username']);#}
        {##}
        {#                var user_list = $('#users_online_list')#}
        {##}
        {#                 var user = $(user_list).find('li').filter(function () {#}
        {#                        return $(this).data('username') == username;#}
        {#                    });#}
        {##}
        {#                if (data['is_logged_in']) {#}
        {#                    if (user.length == 0) {#}
        {#                        user_list.append("<li data-username='" + data['username'] + "'>" + data['full_name'] + "</li>")#}
        {#                    }#}
        {#                }#}
        {#                else {#}
        {#                    if (user) {#}
        {#                        user.remove();#}
        {#                    }#}
        {#                }#}
        {##}
        {#                $('#users_online_count').html("Users online (" + $(user_list).find('li').length + ")")#}
        {#            };#}
        {##}
        {#            if (socket.readyState == WebSocket.OPEN) {#}
        {#                socket.onopen();#}
        {#            }#}
        {##}
        {#        });#}


    </script>

    {#<script type="text/javascript">#}
    {##}
    {#  $(function() {#}
    {#    $("#notificationcreateform").submit(function( event ) {#}
    {#      // Stop form from submitting normally#}
    {#      event.preventDefault();#}
    {##}
    {#      // Get some values from elements on the page:#}
    {#      var $form = $( this );#}
    {#      var url = $form.attr( "action" );#}
    {##}
    {#      // Send the data using post#}
    {#      var posting = $.post( url, $form.serializeArray() );#}
    {##}
    {#      // Put the results in a div#}
    {#      posting.done(function( data ) {#}
    {#        $('#id_name').val('');#}
    {#      });#}
    {##}
    {#    });#}
    {##}
    {#  });#}
    {##}
    {#</script>#}
    {##}
    {#<script type="text/javascript">#}
    {#  var URL_NYT_GET_NEW = "{% url "nyt:json_get" %}";#}
    {#  var URL_NYT_MARK_READ = "{% url "nyt:json_mark_read_base" %}";#}
    {#  var URL_NYT_GOTO = "{% url "nyt:goto_base" %}";#}
    {##}
    {#  var nyt_oldest_id = 0;#}
    {#  var nyt_latest_id = 0;#}
    {#  var nyt_update_timeout = 30000;#}
    {#  var nyt_update_timeout_adjust = 1.2; // factor to adjust between each timeout.#}
    {##}
    {#  // Customixed error handling?#}
    {#  function ajaxError(){}#}
    {##}
    {#  $.ajaxSetup({#}
    {#    timeout: 7000,#}
    {#    cache: false,#}
    {#    error: function(e, xhr, settings, exception) {#}
    {#        ajaxError();#}
    {#    }#}
    {#  });#}
    {##}
    {#  function jsonWrapper(url, callback) {#}
    {#    $.getJSON(url, function(data) {#}
    {#      if (data == null) {#}
    {#        ajaxError();#}
    {#      } else {#}
    {#        callback(data);#}
    {#      }#}
    {#    });#}
    {#  }#}
    {##}
    {#  function nyt_update() {#}
    {##}
    {#    jsonWrapper(#}
    {#      URL_NYT_GET_NEW + nyt_latest_id + '/',#}
    {#      function (data) {#}
    {#        if (data.success) {#}
    {#          $('.notification-cnt').html(data.total_count);#}
    {#          if (data.objects.length> 0) {#}
    {#            $('.notification-cnt').addClass('badge-important');#}
    {#            $('.notifications-empty').hide();#}
    {#          } else {#}
    {#            $('.notification-cnt').removeClass('badge-important');#}
    {#          }#}
    {#          for (var i = data.objects.length - 1; i >= 0; i--) {#}
    {#            var n = data.objects[i];#}
    {#            nyt_latest_id = n.pk>nyt_latest_id ? n.pk:nyt_latest_id;#}
    {#            nyt_oldest_id = (n.pk < nyt_oldest_id || nyt_oldest_id == 0) ? n.pk:nyt_oldest_id;#}
    {#            if (n.occurrences > 1) {#}
    {#              element = $('<li><a href="'+URL_NYT_GOTO+n.pk+'/"><span>'+n.message+'</span> <span class="since">'+n.occurrences_msg+' - ' + n.since + '</span></a></li>')#}
    {#            } else {#}
    {#              element = $('<li><a href="'+URL_NYT_GOTO+n.pk+'/"><span>'+n.message+'</span> <span class="since">'+n.since+'</span></a></li>');#}
    {#            }#}
    {#            element.addClass('notification-li');#}
    {#            element.hide();#}
    {#            element.insertAfter('.notification-before-list');#}
    {#            element.show('slow');#}
    {#          }#}
    {#        }#}
    {#      }#}
    {#    );#}
    {##}
    {#  }#}
    {##}
    {#  // Mark all <li> items read and tell the server.#}
    {#  function nyt_mark_read() {#}
    {#    $('.notification-li').remove();#}
    {#    var url = URL_NYT_MARK_READ + nyt_latest_id + '/' + nyt_oldest_id + '/';#}
    {#    nyt_oldest_id = 0;#}
    {#    nyt_latest_id = 0;#}
    {#    jsonWrapper(url, function (data) {#}
    {#      if (data.success) {#}
    {#        $('.notifications-empty').show();#}
    {#        nyt_update();#}
    {#      }#}
    {#    });#}
    {#  }#}
    {##}
    {#  // Call this function to use traditional polling#}
    {#  function update_timeout() {#}
    {#    setTimeout("nyt_update()", nyt_update_timeout);#}
    {#    setTimeout("update_timeout()", nyt_update_timeout);#}
    {#    nyt_update_timeout *= nyt_update_timeout_adjust;#}
    {#  }#}
    {##}
    {#  // Don't check immediately... some users just click through pages very quickly.#}
    {#  setTimeout("nyt_update()", 2000);#}
    {##}
    {#  var socket = new WebSocket("ws://127.0.0.1:8002/nyt");#}
    {##}
    {#  $(document).ready(function () {#}
    {#    // update_timeout();#}
    {#    socket.onopen = function() {#}
    {#        console.log("Sending hello world");#}
    {#        socket.send("hello world");#}
    {#    }#}
    {#    socket.onmessage = function(e) {#}
    {#      console.log("Got some message, so going to update");#}
    {#      nyt_update();#}
    {#    }#}
    {##}
    {#  });#}
    {##}
    {#</script>#}



{% endblock %}


